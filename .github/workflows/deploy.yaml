name: GH Pages Deploy

on:
  push:
    branches: [main]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout üõé
        uses: actions/checkout@v4

      - name: Install marmite ü´ô
        run: curl -sS https://marmite.blog/install.sh | sh

      - name: Build site üèóÔ∏è
        run: marmite . site --debug

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'site'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
  send_email:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Send email via MailerSend SMTP
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.MAIL_HOST }}
          server_port: ${{ secrets.MAIL_PORT }}
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "Newsletter: Build finished successfully"
          to: ${{ secrets.MAIL_TO }}
          from: ${{ secrets.MAIL_FROM }}
          secure: true
          body: |
            Hello!

            The latest build on the 'main' branch has finished successfully.

            Time: ${{ github.run_started_at }}
            Commit: ${{ github.sha }}
            Triggered by: ${{ github.actor }}

            -- Automated Notification via GitHub CI
